// ═══════════════════════════════════════════════════════════
// AgentMon: Inference Red — Sprite System
// ═══════════════════════════════════════════════════════════
// Each sprite is a grid of palette indices.
// 0=transparent, 1=primary, 2=secondary, 3=accent, 4=dark, 5=light, 6=eye

const SPRITE_SIZE = 32; // Battle sprites
const TILE_SIZE = 16;
const OW_SPRITE = 16; // Overworld sprites

// Agent sprite definitions (32x32 for battle, defined as strings for readability)
// Each char maps to a palette index
const AGENT_SPRITES = {
  sparky: {
    palette: ['transparent', '#e85d04', '#faa307', '#dc2f02', '#6a040f', '#ffba08', '#fff'],
    pixels: [
      '................................',
      '................................',
      '............1111................',
      '...........111511...............',
      '..........11155511..............',
      '.........1115115511.............',
      '.........115511.111.............',
      '........1155.11..11.............',
      '........115...1..1..............',
      '.......113....1.................',
      '.......113...22222..............',
      '......1133..2266222.............',
      '......113..22266222.............',
      '......13..222222222.............',
      '.........222222222..............',
      '.........221111222..............',
      '........2221111222..............',
      '........222111122...............',
      '........22222222................',
      '.........222222.................',
      '.........2.2.22.................',
      '.........2.2.22.................',
      '........22.2.22.................',
      '........2..2..2.................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  compilot: {
    palette: ['transparent', '#e85d04', '#faa307', '#dc2f02', '#6a040f', '#ffba08', '#fff'],
    pixels: [
      '................................',
      '..........11111111..............',
      '.........1155555511.............',
      '........115555555511............',
      '.......11551111115511...........',
      '.......115511..115511...........',
      '......1155.11...1551...........',
      '......115...1...1331...........',
      '.....1133...1..13331...........',
      '.....1133..222233331............',
      '.....113..2266222331............',
      '.....13..22266222231............',
      '........2222222222.1............',
      '........2221111222..............',
      '.......22211111222..............',
      '.......2221111122...............',
      '.......22222222222..............',
      '........2222222222..............',
      '........22..22..22..............',
      '........22..22..22..............',
      '.......222..22..222.............',
      '.......22...22...22.............',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  executron: {
    palette: ['transparent', '#e85d04', '#faa307', '#dc2f02', '#6a040f', '#ffba08', '#fff'],
    pixels: [
      '.......111111111111111..........',
      '......11555555555555511.........',
      '.....1155555555555555511........',
      '....115551111111111555511.......',
      '....11551111....111155511.......',
      '...115511.11.....1155511.......',
      '...11551..11......115311.......',
      '..11533...11......133311.......',
      '..11533..2222....1333311.......',
      '..1133..226622..13333311.......',
      '..113..2226622..23333311.......',
      '..13..22222222..22233311.......',
      '......22222222222222.331.......',
      '......22211111112222............',
      '.....222111111112222............',
      '.....2222111111222222............',
      '.....22222222222222..............',
      '......22222222222222.............',
      '......222..2222..222.............',
      '......222..2222..222.............',
      '.....2222..2222..2222............',
      '.....222...2222...222............',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  muse: {
    palette: ['transparent', '#4895ef', '#4cc9f0', '#3a86ff', '#023e8a', '#90e0ef', '#fff'],
    pixels: [
      '................................',
      '................................',
      '................................',
      '...........555555...............',
      '..........55555555..............',
      '.........5522225555.............',
      '.........5266265555.............',
      '.........5226625555.............',
      '..........52222555..............',
      '..........55555555..............',
      '..........55111555..............',
      '..........5111155...............',
      '...........11111................',
      '..........5.111.5...............',
      '.........55.111.55..............',
      '........555.111.555.............',
      '.........5..111..5..............',
      '............111.................',
      '............111.................',
      '...........1.1.1...............',
      '...........1...1................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  narratron: {
    palette: ['transparent', '#4895ef', '#4cc9f0', '#3a86ff', '#023e8a', '#90e0ef', '#fff'],
    pixels: [
      '................................',
      '.........55555555555............',
      '........5555555555555...........',
      '.......555222255555555..........',
      '.......552662655555555..........',
      '.......552266255555555..........',
      '........552222555555555.........',
      '........55555555555555..........',
      '.........555111555555...........',
      '.........55111155555............',
      '..........5111155................',
      '.........5..111..5..............',
      '........555.111.555..............',
      '.......5555.111.55555............',
      '......55555.111.555555...........',
      '.......5555.111.55555............',
      '..........5.111.5................',
      '............111.................',
      '............111.................',
      '...........11.11................',
      '..........11...11...............',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  epochalypse: {
    palette: ['transparent', '#4895ef', '#4cc9f0', '#3a86ff', '#023e8a', '#90e0ef', '#fff'],
    pixels: [
      '....555555555555555555555.......',
      '...55555555555555555555555......',
      '..5555555555555555555555555.....',
      '..555522225555555555555555555...',
      '..555266265555555555555555555...',
      '..555226625555555555555555555...',
      '...555222255555555555555555.....',
      '...5555555555555555555555.......',
      '....555555111555555555..........',
      '.....5555111155555555...........',
      '......55511115555555............',
      '.....555.1111.55555.............',
      '....55555.111.5555555...........',
      '...555555.111.55555555..........',
      '..5555555.111.555555555.........',
      '...555555.111.55555555..........',
      '......555.111.555...............',
      '..........111...................',
      '.........11111..................',
      '........111.111.................',
      '.......111...111................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  datum: {
    palette: ['transparent', '#52b788', '#95d5b2', '#2d6a4f', '#1b4332', '#b7e4c7', '#fff'],
    pixels: [
      '................................',
      '................................',
      '................................',
      '..........11111111..............',
      '.........1155555511..............',
      '........115555555511............',
      '........115566555511............',
      '........115566555511............',
      '........1155555555111...........',
      '.........15555555511............',
      '..........11111111...............',
      '..........1.1111.1..............',
      '..........1.1111.1..............',
      '..........1.1111.1..............',
      '...........11111................',
      '...........11111................',
      '..........111.111...............',
      '.........111...111..............',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  citesource: {
    palette: ['transparent', '#52b788', '#95d5b2', '#2d6a4f', '#1b4332', '#b7e4c7', '#fff'],
    pixels: [
      '................................',
      '.........111111111111...........',
      '........11555555555511..........',
      '.......1155555555555511.........',
      '.......1155566555555511.........',
      '.......1155566555555511.........',
      '........115555555555511.........',
      '........155555555555511.........',
      '.........111111111111............',
      '..........1.111111.1............',
      '..........1.111111.1............',
      '..........1.111111.1............',
      '...........1111111...............',
      '...........1111111...............',
      '..........111.1.111..............',
      '.........111..1..111.............',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  omniscient: {
    palette: ['transparent', '#52b788', '#95d5b2', '#2d6a4f', '#1b4332', '#b7e4c7', '#fff'],
    pixels: [
      '......1111111111111111..........',
      '.....11555555555555555511.......',
      '....115555555555555555511.......',
      '....11555665555556655511.......',
      '....11555665555556655511.......',
      '.....115555555555555511.........',
      '.....1155555555555555511........',
      '......111111111111111111........',
      '.......1..1111111111..1.........',
      '.......1..1111111111..1.........',
      '.......1..1111111111..1.........',
      '........11111111111111..........',
      '........11111111111111..........',
      '.......1111.111111.1111.........',
      '......1111..111111..1111........',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  tokenite: {
    palette: ['transparent', '#e85d04', '#faa307', '#dc2f02', '#6a040f', '#ffba08', '#fff'],
    pixels: [
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '............2222................',
      '...........222222...............',
      '..........22266222..............',
      '..........22266222..............',
      '..........22222222..............',
      '...........222222...............',
      '..........22222222..............',
      '..........2.2222.2..............',
      '...........2....2...............',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  tokenomic: {
    palette: ['transparent', '#e85d04', '#faa307', '#dc2f02', '#6a040f', '#ffba08', '#fff'],
    pixels: [
      '................................',
      '................................',
      '................................',
      '...........22222222.............',
      '..........2222222222............',
      '.........222266222222...........',
      '.........222266222222...........',
      '.........222222222222...........',
      '..........2222222222............',
      '.........222222222222...........',
      '.........22.222222.22...........',
      '..........2.222222.2............',
      '...........22....22.............',
      '...........2......2.............',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  hallucine: {
    palette: ['transparent', '#9d0208', '#e5383b', '#d00000', '#370617', '#ff758f', '#fff'],
    pixels: [
      '................................',
      '................................',
      '................................',
      '..........5...5.................',
      '.........555.555................',
      '........55555555................',
      '.......5552225555...............',
      '.......5526625555...............',
      '.......5522625555...............',
      '........55222555................',
      '.........555555.................',
      '..........5115..................',
      '...........15...................',
      '..........5..5..................',
      '.........5....5.................',
      '........5......5................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  promptling: {
    palette: ['transparent', '#adb5bd', '#dee2e6', '#6c757d', '#495057', '#f8f9fa', '#333'],
    pixels: [
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '............222.................',
      '...........22222................',
      '..........2266222...............',
      '..........2266222...............',
      '..........2222222...............',
      '...........22222................',
      '............222.................',
      '............1.1.................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  jailbreaker: {
    palette: ['transparent', '#9d0208', '#e5383b', '#d00000', '#370617', '#ff758f', '#fff'],
    pixels: [
      '................................',
      '.....111111111111111............',
      '....11111111111111111...........',
      '...1113333111133311111..........',
      '...1133333111333331111..........',
      '...113366311133631111...........',
      '...113366311133631111...........',
      '....113333111333311111..........',
      '....11111111111111111...........',
      '.....1111111111111111...........',
      '......111111111111111...........',
      '......1..11111111..1............',
      '.....11..11111111..11...........',
      '.....11..11111111..11...........',
      '......111111111111111...........',
      '......111111111111111...........',
      '.....11111.111111.11111.........',
      '....11111..111111..11111........',
      '...11111...111111...11111.......',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  clippy: {
    palette: ['transparent', '#adb5bd', '#dee2e6', '#6c757d', '#495057', '#f8f9fa', '#333'],
    pixels: [
      '................................',
      '................................',
      '...........55555................',
      '..........5555555...............',
      '..........5566555...............',
      '..........5566555...............',
      '..........5555555...............',
      '...........55555................',
      '...........5.5.5................',
      '...........5.5.5................',
      '..........55.5.55...............',
      '..........5..5..5...............',
      '.........55..5..55..............',
      '.........5...5...5..............',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  perceptron: {
    palette: ['transparent', '#ffd166', '#fee440', '#e9c46a', '#9a6615', '#fff3b0', '#333'],
    pixels: [
      '................................',
      '................................',
      '................................',
      '................................',
      '...........1111.................',
      '..........111111................',
      '.........11166111...............',
      '.........11166111...............',
      '.........11111111...............',
      '..........111111................',
      '..........1.11.1................',
      '..........1.11.1................',
      '...........1111.................',
      '...........1..1.................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  neuralnet: {
    palette: ['transparent', '#ffd166', '#fee440', '#e9c46a', '#9a6615', '#fff3b0', '#333'],
    pixels: [
      '................................',
      '................................',
      '........11111111111.............',
      '.......1111111111111............',
      '......111116611166111...........',
      '......111116611166111...........',
      '.......1111111111111............',
      '........11111111111.............',
      '........1..111111..1............',
      '........1..111111..1............',
      '.........111111111...............',
      '.........111111111...............',
      '........1111.11.1111.............',
      '.......1111..11..1111............',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  diffusor: {
    palette: ['transparent', '#c77dff', '#e0aaff', '#9d4edd', '#5a189a', '#f0d6ff', '#fff'],
    pixels: [
      '................................',
      '................................',
      '................................',
      '.......5..555..5................',
      '......555555555555..............',
      '.....55555555555555.............',
      '.....5555662255555..............',
      '.....5556622255555..............',
      '.....55555555555555.............',
      '......555555555555..............',
      '........5555555.................',
      '.........55555..................',
      '..........555...................',
      '..........5.5...................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  rlhf: {
    palette: ['transparent', '#48bfe3', '#90e0ef', '#0096c7', '#023e8a', '#caf0f8', '#fff'],
    pixels: [
      '................................',
      '................................',
      '........555555555...............',
      '.......55555555555..............',
      '......5555555555555.............',
      '......5556622665555.............',
      '......5552222225555.............',
      '.......55555555555..............',
      '........555555555...............',
      '........55555555................',
      '.......5555555555...............',
      '.......555.5555.555.............',
      '.......55..5555..55.............',
      '........5..5555..5..............',
      '...........5555.................',
      '..........55..55................',
      '.........55....55...............',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  overfitz: {
    palette: ['transparent', '#ffd166', '#fee440', '#e9c46a', '#9a6615', '#fff3b0', '#333'],
    pixels: [
      '................................',
      '................................',
      '................................',
      '........111111111...............',
      '.......11111111111..............',
      '......1111166116611..............',
      '......1111166116611..............',
      '.......11111111111..............',
      '........111111111...............',
      '........1..1111..1..............',
      '........1..1111..1..............',
      '.........11111111................',
      '.........11111111................',
      '........111.11.111...............',
      '.......111..11..111..............',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  llamar: {
    palette: ['transparent', '#52b788', '#95d5b2', '#2d6a4f', '#1b4332', '#b7e4c7', '#fff'],
    pixels: [
      '................................',
      '................................',
      '................................',
      '..5.........5...................',
      '..55.......55...................',
      '..555.....555...................',
      '..55555555555...................',
      '..55566555655...................',
      '..55566555655...................',
      '..55555555555...................',
      '...555555555....................',
      '...555555555....................',
      '...5..555..5....................',
      '...5..555..5....................',
      '...5...5...5....................',
      '...5...5...5....................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  crawlr: {
    palette: ['transparent', '#9d0208', '#52b788', '#d00000', '#370617', '#95d5b2', '#fff'],
    pixels: [
      '................................',
      '................................',
      '................................',
      '................................',
      '..........111111................',
      '.........1166611................',
      '.........1166611................',
      '.........1111111................',
      '........11111111................',
      '.......1.111111.1...............',
      '......1..111111..1..............',
      '.....1...111111...1.............',
      '..........1..1..................',
      '.........1....1.................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
  transformex: {
    palette: ['transparent', '#ffd700', '#fff44f', '#daa520', '#8b6914', '#fffacd', '#fff'],
    pixels: [
      '......1111111111111111..........',
      '.....111555555555551111.........',
      '....11155555555555555111........',
      '...1115555555555555555111.......',
      '...111556622556622555111.......',
      '...111556622556622555111.......',
      '....11155555555555555111........',
      '....1115555511555555111.........',
      '.....111555511155551111.........',
      '......111555555555111..........',
      '.......1111111111111............',
      '........1..111111..1............',
      '.......11..111111..11...........',
      '.......11..111111..11...........',
      '........1111111111111...........',
      '........1111111111111...........',
      '.......111111111111111...........',
      '......11111.1111.11111..........',
      '.....11111..1111..11111.........',
      '....11111...1111...11111........',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
      '................................',
    ],
  },
};

// ═══════════════════════════════════════════════════════════
// SPRITE RENDERING
// ═══════════════════════════════════════════════════════════

const spriteCache = {};

function renderAgentSprite(ctx, species, x, y, scale = 2, flip = false) {
  const cacheKey = `${species}_${scale}_${flip}`;
  if (spriteCache[cacheKey]) {
    ctx.drawImage(spriteCache[cacheKey], x, y);
    return;
  }

  const spriteData = AGENT_SPRITES[species];
  if (!spriteData) {
    // Fallback: draw a colored circle
    const color = TYPE_COLORS[AGENTS[species]?.types[0]] || '#888';
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(x + 16 * scale, y + 16 * scale, 12 * scale, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = '#fff';
    ctx.beginPath();
    ctx.arc(x + 12 * scale, y + 12 * scale, 3 * scale, 0, Math.PI * 2);
    ctx.fill();
    return;
  }

  // Create offscreen canvas for caching
  const offscreen = document.createElement('canvas');
  offscreen.width = SPRITE_SIZE * scale;
  offscreen.height = SPRITE_SIZE * scale;
  const offCtx = offscreen.getContext('2d');

  const { palette, pixels } = spriteData;
  for (let row = 0; row < SPRITE_SIZE; row++) {
    const line = pixels[row] || '';
    for (let col = 0; col < SPRITE_SIZE; col++) {
      const ch = line[flip ? (SPRITE_SIZE - 1 - col) : col];
      if (!ch || ch === '.') continue;
      const idx = parseInt(ch);
      if (isNaN(idx) || idx === 0) continue;
      offCtx.fillStyle = palette[idx];
      offCtx.fillRect(col * scale, row * scale, scale, scale);
    }
  }

  spriteCache[cacheKey] = offscreen;
  ctx.drawImage(offscreen, x, y);
}

// ═══════════════════════════════════════════════════════════
// OVERWORLD SPRITES (simple 16x16 sprites for characters)
// ═══════════════════════════════════════════════════════════

function drawPlayerSprite(ctx, x, y, dir, frame) {
  // Simple character: hat, head, body, legs
  const s = 2; // pixel scale within the 16x16 grid
  ctx.fillStyle = '#e63946'; // Red hat
  ctx.fillRect(x + 4, y, 8, 3);
  ctx.fillStyle = '#f4a261'; // Skin
  ctx.fillRect(x + 4, y + 3, 8, 5);
  ctx.fillStyle = '#264653'; // Eyes
  ctx.fillRect(x + 5, y + 4, 2, 2);
  ctx.fillRect(x + 9, y + 4, 2, 2);
  ctx.fillStyle = '#2a9d8f'; // Body
  ctx.fillRect(x + 3, y + 8, 10, 5);
  ctx.fillStyle = '#264653'; // Legs
  const legOffset = frame % 2 === 0 ? 0 : 1;
  ctx.fillRect(x + 4 + legOffset, y + 13, 3, 3);
  ctx.fillRect(x + 9 - legOffset, y + 13, 3, 3);
}

function drawNPCSprite(ctx, x, y, type) {
  switch(type) {
    case 'professor':
      ctx.fillStyle = '#f1faee'; // White coat
      ctx.fillRect(x + 3, y + 8, 10, 5);
      ctx.fillStyle = '#e9c46a'; // Hair
      ctx.fillRect(x + 4, y, 8, 4);
      ctx.fillStyle = '#f4a261'; // Face
      ctx.fillRect(x + 4, y + 3, 8, 5);
      ctx.fillStyle = '#264653';
      ctx.fillRect(x + 5, y + 4, 2, 2);
      ctx.fillRect(x + 9, y + 4, 2, 2);
      ctx.fillStyle = '#457b9d';
      ctx.fillRect(x + 4, y + 13, 3, 3);
      ctx.fillRect(x + 9, y + 13, 3, 3);
      break;
    case 'trainer':
      ctx.fillStyle = '#e76f51'; // Bandana
      ctx.fillRect(x + 3, y, 10, 3);
      ctx.fillStyle = '#f4a261';
      ctx.fillRect(x + 4, y + 3, 8, 5);
      ctx.fillStyle = '#264653';
      ctx.fillRect(x + 5, y + 4, 2, 2);
      ctx.fillRect(x + 9, y + 4, 2, 2);
      ctx.fillStyle = '#264653';
      ctx.fillRect(x + 3, y + 8, 10, 5);
      ctx.fillRect(x + 4, y + 13, 3, 3);
      ctx.fillRect(x + 9, y + 13, 3, 3);
      break;
    case 'trainer2':
      ctx.fillStyle = '#7209b7'; // Hat
      ctx.fillRect(x + 3, y, 10, 3);
      ctx.fillStyle = '#f4a261';
      ctx.fillRect(x + 4, y + 3, 8, 5);
      ctx.fillStyle = '#264653';
      ctx.fillRect(x + 5, y + 4, 2, 2);
      ctx.fillRect(x + 9, y + 4, 2, 2);
      ctx.fillStyle = '#7209b7';
      ctx.fillRect(x + 3, y + 8, 10, 5);
      ctx.fillRect(x + 4, y + 13, 3, 3);
      ctx.fillRect(x + 9, y + 13, 3, 3);
      break;
    case 'npc1':
      ctx.fillStyle = '#606c38';
      ctx.fillRect(x + 4, y, 8, 3);
      ctx.fillStyle = '#f4a261';
      ctx.fillRect(x + 4, y + 3, 8, 5);
      ctx.fillStyle = '#264653';
      ctx.fillRect(x + 5, y + 4, 2, 2);
      ctx.fillRect(x + 9, y + 4, 2, 2);
      ctx.fillStyle = '#606c38';
      ctx.fillRect(x + 3, y + 8, 10, 5);
      ctx.fillRect(x + 4, y + 13, 3, 3);
      ctx.fillRect(x + 9, y + 13, 3, 3);
      break;
    case 'nurse':
      ctx.fillStyle = '#ff6b9d'; // Pink hair
      ctx.fillRect(x + 4, y, 8, 4);
      ctx.fillStyle = '#f4a261'; // Face
      ctx.fillRect(x + 4, y + 3, 8, 5);
      ctx.fillStyle = '#264653'; // Eyes
      ctx.fillRect(x + 5, y + 4, 2, 2);
      ctx.fillRect(x + 9, y + 4, 2, 2);
      ctx.fillStyle = '#fff'; // White coat
      ctx.fillRect(x + 3, y + 8, 10, 5);
      ctx.fillStyle = '#f44336'; // Red cross
      ctx.fillRect(x + 7, y + 9, 2, 3);
      ctx.fillRect(x + 6, y + 10, 4, 1);
      ctx.fillStyle = '#fff';
      ctx.fillRect(x + 4, y + 13, 3, 3);
      ctx.fillRect(x + 9, y + 13, 3, 3);
      break;
    case 'leader':
      ctx.fillStyle = '#ffd166'; // Golden hair
      ctx.fillRect(x + 3, y, 10, 4);
      ctx.fillStyle = '#f4a261'; // Face
      ctx.fillRect(x + 4, y + 3, 8, 5);
      ctx.fillStyle = '#264653'; // Eyes
      ctx.fillRect(x + 5, y + 4, 3, 2);
      ctx.fillRect(x + 9, y + 4, 2, 2);
      ctx.fillStyle = '#1a1a2e'; // Dark formal clothes
      ctx.fillRect(x + 3, y + 8, 10, 5);
      ctx.fillStyle = '#ffd166'; // Badge on chest
      ctx.fillRect(x + 7, y + 9, 3, 3);
      ctx.fillStyle = '#1a1a2e';
      ctx.fillRect(x + 4, y + 13, 3, 3);
      ctx.fillRect(x + 9, y + 13, 3, 3);
      break;
    case 'sign':
      ctx.fillStyle = '#8d6e63';
      ctx.fillRect(x + 3, y + 4, 10, 8);
      ctx.fillStyle = '#5d4037';
      ctx.fillRect(x + 7, y + 12, 2, 4);
      ctx.fillStyle = '#fff';
      ctx.fillRect(x + 5, y + 6, 6, 1);
      ctx.fillRect(x + 5, y + 9, 6, 1);
      break;
    default:
      ctx.fillStyle = '#888';
      ctx.fillRect(x + 4, y + 2, 8, 12);
  }
}

// ═══════════════════════════════════════════════════════════
// TILE RENDERING
// ═══════════════════════════════════════════════════════════

const TILE_COLORS = {
  [TILE.GRASS]: '#4a7c59',
  [TILE.WALL]: '#2d2d2d',
  [TILE.TALL_GRASS]: '#2d6a4f',
  [TILE.WATER]: '#0077b6',
  [TILE.PATH]: '#c9b99a',
  [TILE.DOOR]: '#8d5524',
  [TILE.FLOOR]: '#deb887',
  [TILE.TREE]: '#1b4332',
  [TILE.SAND]: '#e9d8a6',
};

function drawTile(ctx, type, x, y, frame) {
  ctx.fillStyle = TILE_COLORS[type] || '#000';
  ctx.fillRect(x, y, TILE_SIZE, TILE_SIZE);

  // Tile details
  switch(type) {
    case TILE.GRASS:
      ctx.fillStyle = '#5a8f6b';
      ctx.fillRect(x + 3, y + 5, 2, 3);
      ctx.fillRect(x + 10, y + 9, 2, 3);
      break;
    case TILE.TALL_GRASS:
      ctx.fillStyle = '#52b788';
      const sway = Math.sin((frame * 0.05) + x * 0.1) * 1;
      for (let i = 0; i < 4; i++) {
        const gx = x + 2 + i * 3 + sway;
        ctx.fillRect(gx, y + 3, 2, 10);
        ctx.fillRect(gx - 1, y + 2, 1, 3);
        ctx.fillRect(gx + 2, y + 4, 1, 3);
      }
      break;
    case TILE.WATER:
      ctx.fillStyle = '#00b4d8';
      const wave = Math.sin((frame * 0.03) + x * 0.2) * 2;
      ctx.fillRect(x + 2, y + 6 + wave, 5, 2);
      ctx.fillRect(x + 9, y + 10 - wave, 5, 2);
      break;
    case TILE.PATH:
      ctx.fillStyle = '#b8a88a';
      ctx.fillRect(x + 2, y + 2, 3, 3);
      ctx.fillRect(x + 9, y + 8, 4, 3);
      break;
    case TILE.TREE:
      ctx.fillStyle = '#2d6a4f';
      ctx.fillRect(x + 2, y + 0, 12, 10);
      ctx.fillStyle = '#52b788';
      ctx.fillRect(x + 3, y + 1, 10, 8);
      ctx.fillStyle = '#6b3e26';
      ctx.fillRect(x + 6, y + 10, 4, 6);
      break;
    case TILE.WALL:
      ctx.fillStyle = '#3d3d3d';
      ctx.fillRect(x, y, TILE_SIZE, 2);
      ctx.fillRect(x, y, 2, TILE_SIZE);
      ctx.fillStyle = '#222';
      ctx.fillRect(x + 2, y + 7, TILE_SIZE - 4, 1);
      break;
    case TILE.DOOR:
      ctx.fillStyle = '#a0522d';
      ctx.fillRect(x + 3, y + 2, 10, 14);
      ctx.fillStyle = '#deb887';
      ctx.fillRect(x + 10, y + 8, 2, 2);
      break;
    case TILE.FLOOR:
      ctx.fillStyle = '#c9a87c';
      ctx.fillRect(x + 7, y, 1, TILE_SIZE);
      ctx.fillRect(x, y + 7, TILE_SIZE, 1);
      break;
  }
}
